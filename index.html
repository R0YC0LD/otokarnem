<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OtoServis Pro - Araç ve Servis Yönetimi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --background: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 16px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background-color: var(--background); color: var(--text-main); line-height: 1.6; padding-bottom: 50px; }

        /* YARDIMCI SINIFLAR */
        .hidden { display: none !important; }
        .mt-2 { margin-top: 1rem; }
        .text-muted { color: var(--text-muted); font-size: 0.9rem; }
        .text-center { text-align: center; }
        .w-100 { width: 100%; }

        /* NAVBAR */
        .navbar { background: var(--surface); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); padding: 1rem 0; position: sticky; top: 0; z-index: 100; }
        .nav-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
        .logo i { color: var(--primary); font-size: 1.8rem; }
        .logo span { color: var(--primary); }

        /* ANA KAPLAYICI */
        .main-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; min-height: 80vh; }
        .view { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* KARTLAR */
        .auth-box { background: var(--surface); padding: 3rem; border-radius: var(--radius); box-shadow: var(--shadow); max-width: 480px; margin: 0 auto; border: 1px solid rgba(255,255,255,0.5); }
        .auth-box.wide { max-width: 900px; }
        .auth-header { text-align: center; margin-bottom: 2rem; }
        .auth-header h2 { color: var(--text-main); margin-bottom: 0.5rem; font-weight: 800; letter-spacing: -0.5px; }
        .auth-footer { text-align: center; margin-top: 20px; font-size: 0.9rem; }
        .auth-footer a { color: var(--primary); text-decoration: none; font-weight: 600; transition: color 0.2s; }
        .auth-footer a:hover { color: var(--primary-dark); }

        /* FORMLAR */
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem; color: var(--text-main); }
        input, select, textarea { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; transition: all 0.2s; background: #fff; color: var(--text-main); }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        
        .input-icon { position: relative; }
        .input-icon i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }
        .input-icon input { padding-left: 45px; }

        /* ROLE SELECTOR (YENİ) */
        .role-selector { display: flex; background: #f1f5f9; padding: 5px; border-radius: 12px; margin-bottom: 25px; }
        .role-option { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 8px; font-weight: 600; color: var(--text-muted); transition: all 0.3s; }
        .role-option.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .role-option:hover:not(.active) { color: var(--text-main); }

        /* BUTONLAR */
        .btn { padding: 14px 28px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; letter-spacing: 0.3px; }
        .btn-block { width: 100%; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; padding: 10px 20px; font-size: 0.9rem; }
        .btn-outline { border: 2px solid var(--primary); color: var(--primary); background: transparent; padding: 8px 16px; font-size: 0.85rem; }
        .btn-outline:hover { background: var(--primary); color: white; }

        /* DASHBOARD */
        .dashboard-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 2rem; background: var(--surface); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); gap: 20px; }
        .qr-box { text-align: center; background: white; padding: 15px; border-radius: 12px; border: 2px solid var(--border); transition: transform 0.3s; }
        .qr-box:hover { transform: scale(1.05); }
        
        .stats-box { display: flex; gap: 20px; flex-wrap: wrap; }
        .stat-item { flex: 1; min-width: 120px; text-align: center; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .stat-val { display: block; font-size: 1.8rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        .content-card { background: var(--surface); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; height: 100%; border: 1px solid rgba(0,0,0,0.03); }
        .content-card h3 { border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; margin-bottom: 25px; color: var(--text-main); font-size: 1.25rem; font-weight: 700; }

        /* TABLO */
        .table-responsive { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); }
        .table { width: 100%; border-collapse: collapse; min-width: 650px; }
        .table th { background-color: #f8fafc; padding: 18px; text-align: left; font-weight: 700; color: var(--secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .table td { padding: 18px; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 0.95rem; }
        .table tr:last-child td { border-bottom: none; }
        .table tr:hover { background-color: #f8fafc; }
        
        /* IZGARA SİSTEMİ */
        .row { display: flex; gap: 30px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 320px; }
        .row-smart { display: flex; gap: 20px; }
        .row-smart .form-group { flex: 1; }
        .search-wrapper { display: flex; gap: 10px; }
        .btn-icon { background: var(--primary); color: white; border: none; border-radius: 12px; width: 56px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: background 0.2s; }
        .btn-icon:hover { background: var(--primary-dark); }

        /* MODAL & TOAST */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 450px; position: relative; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .close-modal { position: absolute; top: 20px; right: 25px; font-size: 24px; cursor: pointer; color: var(--text-muted); transition: color 0.2s; }
        .close-modal:hover { color: var(--danger); }
        
        .star-rating { font-size: 2.5rem; color: #fbbf24; cursor: pointer; margin: 20px 0; display: flex; justify-content: center; gap: 5px; }
        .star-rating i { transition: transform 0.2s; }
        .star-rating i:hover { transform: scale(1.2); }

        #toast-container { position: fixed; top: 30px; right: 30px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #1e293b; color: white; padding: 16px 24px; border-radius: 12px; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); min-width: 300px; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* BOŞ DURUM */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); border: 2px dashed var(--border); border-radius: var(--radius); }
        .empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.3; color: var(--primary); }

        @media (max-width: 768px) {
            .nav-content { flex-direction: column; gap: 15px; }
            .row-smart { flex-direction: column; gap: 0; }
            .dashboard-header { flex-direction: column; text-align: center; }
            .auth-box { padding: 2rem; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <nav class="navbar">
        <div class="container nav-content">
            <div class="logo">
                <i class="fa-solid fa-car-on"></i> 
                <div>OtoServis<span>Pro</span></div>
            </div>
            <div class="nav-links">
                <span id="user-display" class="hidden" style="font-weight: 600; margin-right: 15px; color: var(--text-main);"></span>
                <button id="logout-btn" class="btn btn-danger hidden"><i class="fa-solid fa-right-from-bracket"></i> Çıkış</button>
            </div>
        </div>
    </nav>

    <div class="main-container">

        <section id="view-login" class="view active">
            <div class="auth-box">
                <div class="auth-header">
                    <h2>Hoş Geldiniz</h2>
                    <p class="text-muted">Servis geçmişine ulaşmak veya işlem yapmak için giriş yapın.</p>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label>TC Kimlik No / Usta Kullanıcı Adı</label>
                        <div class="input-icon">
                            <i class="fa-solid fa-user"></i>
                            <input type="text" id="login-id" placeholder="Kimlik no veya kullanıcı adı" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Şifre</label>
                        <div class="input-icon">
                            <i class="fa-solid fa-lock"></i>
                            <input type="password" id="login-pass" placeholder="••••••••" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Giriş Yap</button>
                </form>
                <div class="auth-footer">
                    Hesabınız yok mu? <a href="#" onclick="app.router('register')">Hemen Kayıt Ol</a>
                </div>
            </div>
        </section>

        <section id="view-register" class="view hidden">
            <div class="auth-box wide">
                <div class="auth-header">
                    <h2>Hesap Oluştur</h2>
                    <p class="text-muted">Hangi tür hesap oluşturmak istiyorsunuz?</p>
                </div>

                <div class="role-selector">
                    <div class="role-option active" onclick="app.setRegisterRole('user')">
                        <i class="fa-solid fa-user"></i> Araç Sahibi
                    </div>
                    <div class="role-option" onclick="app.setRegisterRole('master')">
                        <i class="fa-solid fa-screwdriver-wrench"></i> Usta / Servis
                    </div>
                </div>

                <form id="register-form">
                    <input type="hidden" id="reg-role" value="user">
                    
                    <div class="row">
                        <div class="col">
                            <h4 style="color: var(--primary); margin-bottom: 20px; padding-bottom:10px; border-bottom:2px solid #f1f5f9;">
                                <i class="fa-solid fa-id-card"></i> Hesap Bilgileri
                            </h4>
                            
                            <div class="form-group">
                                <label>Ad Soyad</label>
                                <input type="text" id="reg-name" required placeholder="Adınız Soyadınız">
                            </div>
                            
                            <div class="form-group" id="group-tc">
                                <label>TC Kimlik No</label>
                                <input type="text" id="reg-tc" maxlength="11" placeholder="11 Haneli TC">
                            </div>
                            <div class="form-group hidden" id="group-username">
                                <label>Kullanıcı Adı (Giriş için)</label>
                                <input type="text" id="reg-username" placeholder="Örn: guvenoto">
                            </div>

                            <div class="form-group">
                                <label>Şifre Belirle</label>
                                <input type="password" id="reg-pass" required placeholder="Güçlü bir şifre">
                            </div>
                        </div>

                        <div class="col">
                            <div id="section-car-info">
                                <h4 style="color: var(--primary); margin-bottom: 20px; padding-bottom:10px; border-bottom:2px solid #f1f5f9;">
                                    <i class="fa-solid fa-car"></i> Araç Bilgileri
                                </h4>
                                <div class="form-group">
                                    <label>Plaka</label>
                                    <input type="text" id="reg-plate" placeholder="34ABC123" style="text-transform: uppercase;">
                                </div>
                                <div class="form-group">
                                    <label>Şasi Numarası (VIN)</label>
                                    <input type="text" id="reg-vin" placeholder="Şasi No" style="text-transform: uppercase;">
                                </div>
                                <div class="form-group">
                                    <label>Marka / Model</label>
                                    <input type="text" id="reg-model" placeholder="Örn: Fiat Egea 2023">
                                </div>
                            </div>

                            <div id="section-shop-info" class="hidden">
                                <h4 style="color: var(--primary); margin-bottom: 20px; padding-bottom:10px; border-bottom:2px solid #f1f5f9;">
                                    <i class="fa-solid fa-shop"></i> Dükkan Bilgileri
                                </h4>
                                <div class="form-group">
                                    <label>İşletme / Dükkan Adı</label>
                                    <input type="text" id="reg-shopname" placeholder="Örn: Güven Oto Servis">
                                </div>
                                <div class="form-group">
                                    <label>Telefon Numarası</label>
                                    <input type="text" id="reg-phone" placeholder="0555 555 55 55">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success btn-block mt-2" style="margin-top: 30px;">
                        <i class="fa-solid fa-check-circle"></i> Kaydı Tamamla
                    </button>
                </form>
                
                <div class="auth-footer">
                    Zaten hesabınız var mı? <a href="#" onclick="app.router('login')">Giriş Yap</a>
                </div>
            </div>
        </section>

        <section id="view-user-dashboard" class="view hidden">
            <div class="dashboard-header">
                <div>
                    <span class="status-badge" style="background:#e0e7ff; color:var(--primary); padding:5px 10px; border-radius:8px; font-size:0.8rem; font-weight:700;">ARAÇ SAHİBİ</span>
                    <h1 style="font-size: 1.8rem; margin-top:10px;">Aracım</h1>
                    <p id="user-car-detail" class="text-muted">Araç bilgileri yükleniyor...</p>
                </div>
                <div class="qr-box">
                    <div id="qrcode"></div>
                    <small style="display:block; margin-top:10px; font-weight:700; color:var(--text-main);">Servis QR Kodu</small>
                </div>
            </div>

            <div class="content-card">
                <h3><i class="fa-solid fa-clock-rotate-left"></i> Servis Geçmişi</h3>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Servis / Usta</th>
                                <th>İşlem Detayı (KM)</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="user-history-body"></tbody>
                    </table>
                </div>
                <div id="user-empty-state" class="empty-state hidden">
                    <i class="fa-regular fa-folder-open"></i>
                    <p>Henüz kayıtlı bir servis işleminiz bulunmuyor.</p>
                </div>
            </div>
        </section>

        <section id="view-master-dashboard" class="view hidden">
            <div class="dashboard-header">
                <div>
                    <span class="status-badge" style="background:#fee2e2; color:var(--danger); padding:5px 10px; border-radius:8px; font-size:0.8rem; font-weight:700;">USTA PANELİ</span>
                    <h1 style="font-size: 1.8rem; margin-top:10px;" id="master-header-name">Usta Paneli</h1>
                    <p class="text-muted">Servis işlemlerini kaydedin ve müşteri memnuniyetini yönetin.</p>
                </div>
                <div class="stats-box">
                    <div class="stat-item">
                        <span id="master-rating" class="stat-val">0.0</span>
                        <span class="stat-label">Ort. Puan</span>
                    </div>
                    <div class="stat-item">
                        <span id="master-count" class="stat-val">0</span>
                        <span class="stat-label">Toplam İşlem</span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="content-card">
                        <h3><i class="fa-solid fa-screwdriver-wrench"></i> Yeni İşlem Ekle</h3>
                        <form id="service-add-form">
                            <div class="form-group">
                                <label>Müşteri Plakası</label>
                                <div class="search-wrapper">
                                    <input type="text" id="serv-plate" placeholder="34ABC123" required style="text-transform: uppercase;">
                                    <button type="button" class="btn-icon" onclick="app.checkPlate()"><i class="fa-solid fa-magnifying-glass"></i></button>
                                </div>
                                <small id="plate-status" style="display:block; margin-top:10px; font-weight:600; min-height:20px;"></small>
                            </div>
                            
                            <div class="row-smart">
                                <div class="form-group">
                                    <label>Kilometre</label>
                                    <input type="number" id="serv-km" placeholder="Örn: 120000" required>
                                </div>
                                <div class="form-group">
                                    <label>Tarih</label>
                                    <input type="date" id="serv-date" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Yapılan İşlemler</label>
                                <textarea id="serv-desc" rows="4" placeholder="Değişen parçalar ve işlem detayları..." required></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary btn-block">Kaydı İşle</button>
                        </form>
                    </div>
                </div>

                <div class="col">
                    <div class="content-card">
                        <h3><i class="fa-solid fa-list-check"></i> Son Yaptığım İşlemler</h3>
                        <ul id="master-recent-list" style="list-style: none; padding:0;"></ul>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <div id="modal-rate" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="app.closeModal()">&times;</span>
            <h3>Hizmeti Değerlendir</h3>
            <p class="text-muted">Bu servis işleminden ne kadar memnun kaldınız?</p>
            <div class="star-rating">
                <i class="fa-regular fa-star" data-val="1"></i>
                <i class="fa-regular fa-star" data-val="2"></i>
                <i class="fa-regular fa-star" data-val="3"></i>
                <i class="fa-regular fa-star" data-val="4"></i>
                <i class="fa-regular fa-star" data-val="5"></i>
            </div>
            <textarea id="rate-comment" placeholder="Yorumunuzu yazın (Opsiyonel)" rows="3"></textarea>
            <button id="btn-submit-rate" class="btn btn-success btn-block mt-2">Puanı Gönder</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        class App {
            constructor() {
                this.DB_KEY = 'otoServisPro_DB_v3'; // Versiyonu güncelledik
                this.currentUser = null;
                this.currentView = 'view-login';
                this.db = this.loadDB();
                
                this.initEvents();
                this.checkSession();
            }

            // --- VERİTABANI ---
            loadDB() {
                const stored = localStorage.getItem(this.DB_KEY);
                if (stored) return JSON.parse(stored);
                
                // Varsayılan Veriler
                const seedData = {
                    users: [],
                    masters: [
                        { 
                            id: 'm_1', 
                            username: 'usta1', 
                            password: '123', 
                            name: 'Mehmet Usta', 
                            shopName: 'Güven Oto Performans',
                            rating: 4.5,
                            ratingCount: 2
                        }
                    ],
                    services: []
                };
                this.saveDB(seedData);
                return seedData;
            }

            saveDB(data) {
                localStorage.setItem(this.DB_KEY, JSON.stringify(data));
                this.db = data;
            }

            // --- ROUTING ---
            router(viewName) {
                document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`view-${viewName}`);
                if (target) {
                    target.classList.remove('hidden');
                    this.currentView = viewName;
                }

                if (viewName === 'user-dashboard') this.loadUserDashboard();
                if (viewName === 'master-dashboard') this.loadMasterDashboard();
            }

            // --- UI HELPERS ---
            setRegisterRole(role) {
                // UI Güncelleme
                document.querySelectorAll('.role-option').forEach(el => el.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                document.getElementById('reg-role').value = role;

                const carInfo = document.getElementById('section-car-info');
                const shopInfo = document.getElementById('section-shop-info');
                const tcGroup = document.getElementById('group-tc');
                const userGroup = document.getElementById('group-username');
                
                // Gerekli alanları göster/gizle ve required özelliklerini yönet
                if (role === 'master') {
                    carInfo.classList.add('hidden');
                    shopInfo.classList.remove('hidden');
                    
                    tcGroup.classList.add('hidden');
                    userGroup.classList.remove('hidden');

                    document.getElementById('reg-plate').removeAttribute('required');
                    document.getElementById('reg-vin').removeAttribute('required');
                    document.getElementById('reg-tc').removeAttribute('required');
                    
                    document.getElementById('reg-username').setAttribute('required', 'true');
                    document.getElementById('reg-shopname').setAttribute('required', 'true');

                } else {
                    carInfo.classList.remove('hidden');
                    shopInfo.classList.add('hidden');
                    
                    tcGroup.classList.remove('hidden');
                    userGroup.classList.add('hidden');

                    document.getElementById('reg-plate').setAttribute('required', 'true');
                    document.getElementById('reg-vin').setAttribute('required', 'true');
                    document.getElementById('reg-tc').setAttribute('required', 'true');
                    
                    document.getElementById('reg-username').removeAttribute('required');
                    document.getElementById('reg-shopname').removeAttribute('required');
                }
            }

            // --- AUTH ---
            checkSession() {
                const sessionUser = sessionStorage.getItem('currentUser');
                if (sessionUser) {
                    this.currentUser = JSON.parse(sessionUser);
                    this.updateNavbar();
                    if (this.currentUser.role === 'master') {
                        this.router('master-dashboard');
                    } else {
                        this.router('user-dashboard');
                    }
                } else {
                    this.router('login');
                }
            }

            login(id, password) {
                // Usta Kontrolü (Veritabanındaki masters dizisinden)
                const master = this.db.masters.find(m => m.username === id && m.password === password);
                if (master) {
                    this.setSession(master, 'master');
                    this.showToast(`Hoşgeldin ${master.name}`, 'success');
                    return;
                }

                // Kullanıcı Kontrolü
                const user = this.db.users.find(u => u.tc === id && u.password === password);
                if (user) {
                    this.setSession(user, 'user');
                    this.showToast(`Hoşgeldin ${user.name}`, 'success');
                    return;
                }

                this.showToast('Hatalı kullanıcı adı/TC veya şifre!', 'error');
            }

            register(e) {
                e.preventDefault();
                const role = document.getElementById('reg-role').value;
                const name = document.getElementById('reg-name').value.trim();
                const pass = document.getElementById('reg-pass').value.trim();

                if(role === 'user') {
                    const tc = document.getElementById('reg-tc').value.trim();
                    const plate = document.getElementById('reg-plate').value.trim().toUpperCase();
                    
                    if(this.db.users.find(u => u.tc === tc)) return this.showToast('Bu TC zaten kayıtlı!', 'error');
                    if(this.db.users.find(u => u.plate === plate)) return this.showToast('Bu plaka zaten kayıtlı!', 'error');

                    const newUser = {
                        id: 'u_' + Date.now(),
                        role: 'user',
                        name: name,
                        tc: tc,
                        password: pass,
                        plate: plate,
                        vin: document.getElementById('reg-vin').value.trim().toUpperCase(),
                        model: document.getElementById('reg-model').value.trim()
                    };

                    this.db.users.push(newUser);
                    this.saveDB(this.db);
                    this.showToast('Kayıt Başarılı!', 'success');
                    setTimeout(() => this.setSession(newUser, 'user'), 1000);

                } else if (role === 'master') {
                    const username = document.getElementById('reg-username').value.trim();
                    const shopname = document.getElementById('reg-shopname').value.trim();
                    
                    if(this.db.masters.find(m => m.username === username)) return this.showToast('Bu kullanıcı adı dolu!', 'error');

                    const newMaster = {
                        id: 'm_' + Date.now(),
                        role: 'master',
                        username: username,
                        password: pass,
                        name: name,
                        shopName: shopname,
                        phone: document.getElementById('reg-phone').value.trim(),
                        rating: 0,
                        ratingCount: 0
                    };

                    this.db.masters.push(newMaster);
                    this.saveDB(this.db);
                    this.showToast('Usta Kaydı Başarılı!', 'success');
                    setTimeout(() => this.setSession(newMaster, 'master'), 1000);
                }
            }

            setSession(user, role) {
                const sessionData = { ...user, role };
                sessionStorage.setItem('currentUser', JSON.stringify(sessionData));
                this.currentUser = sessionData;
                this.updateNavbar();
                this.router(role === 'master' ? 'master-dashboard' : 'user-dashboard');
            }

            logout() {
                sessionStorage.removeItem('currentUser');
                this.currentUser = null;
                this.updateNavbar();
                this.router('login');
                this.showToast('Çıkış yapıldı', 'success');
            }

            updateNavbar() {
                const display = document.getElementById('user-display');
                const logoutBtn = document.getElementById('logout-btn');
                if (this.currentUser) {
                    display.innerHTML = this.currentUser.role === 'master' 
                        ? `<i class="fa-solid fa-screwdriver-wrench"></i> ${this.currentUser.shopName}`
                        : `<i class="fa-solid fa-user"></i> ${this.currentUser.name}`;
                    display.classList.remove('hidden');
                    logoutBtn.classList.remove('hidden');
                } else {
                    display.classList.add('hidden');
                    logoutBtn.classList.add('hidden');
                }
            }

            // --- USER DASHBOARD ---
            loadUserDashboard() {
                if (!this.currentUser) return;
                
                document.getElementById('user-car-detail').innerText = `${this.currentUser.plate} - ${this.currentUser.model}`;
                
                const qrDiv = document.getElementById('qrcode');
                qrDiv.innerHTML = '';
                new QRCode(qrDiv, {
                    text: `https://otoservispro.com?vin=${this.currentUser.vin}`,
                    width: 100,
                    height: 100
                });

                const myServices = this.db.services.filter(s => s.vin === this.currentUser.vin).reverse();
                const tbody = document.getElementById('user-history-body');
                tbody.innerHTML = '';

                if (myServices.length === 0) {
                    document.getElementById('user-empty-state').classList.remove('hidden');
                } else {
                    document.getElementById('user-empty-state').classList.add('hidden');
                    myServices.forEach(s => {
                        const master = this.db.masters.find(m => m.id === s.masterId);
                        
                        let btnHtml = '';
                        if(s.isRated) {
                            btnHtml = `<span class="status-badge status-completed"><i class="fa-solid fa-check"></i> ${s.rating} Puan</span>`;
                        } else {
                            btnHtml = `<button onclick="app.openRateModal('${s.id}')" class="btn btn-outline btn-sm">Puanla</button>`;
                        }

                        const tr = `
                            <tr>
                                <td><div style="font-weight:600;">${this.formatDate(s.date)}</div></td>
                                <td>
                                    <div style="font-weight:700; color:var(--primary);">${master ? master.shopName : 'Bilinmeyen Servis'}</div>
                                    <small class="text-muted">${master ? master.name : ''}</small>
                                </td>
                                <td>
                                    <div style="font-weight:700;">${s.km} KM</div>
                                    <div style="font-size:0.9rem; margin-top:5px;">${s.desc}</div>
                                </td>
                                <td>${btnHtml}</td>
                            </tr>
                        `;
                        tbody.innerHTML += tr;
                    });
                }
            }

            // --- MASTER DASHBOARD ---
            loadMasterDashboard() {
                if (!this.currentUser) return;
                
                document.getElementById('master-header-name').innerText = this.currentUser.shopName;
                document.getElementById('master-rating').innerText = this.currentUser.rating || '0.0';
                
                // Toplam işlem sayısını hesapla
                const myWorks = this.db.services.filter(s => s.masterId === this.currentUser.id);
                document.getElementById('master-count').innerText = myWorks.length;

                const list = document.getElementById('master-recent-list');
                list.innerHTML = '';
                
                const recentWorks = [...myWorks].reverse().slice(0, 5);
                
                if(recentWorks.length === 0) list.innerHTML = '<li class="text-muted text-center" style="padding:20px;">Henüz işlem kaydı yok.</li>';
                
                recentWorks.forEach(w => {
                    list.innerHTML += `
                        <li style="padding:15px; border-bottom:1px solid #f1f5f9;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                <span style="font-weight:800; color:var(--text-main); font-size:1.1rem;">${w.plate}</span>
                                <span class="text-muted" style="font-size:0.85rem;">${this.formatDate(w.date)}</span>
                            </div>
                            <div class="text-muted" style="font-size:0.9rem;">${w.desc.substring(0, 50)}${w.desc.length>50?'...':''}</div>
                        </li>
                    `;
                });
            }

            checkPlate() {
                const plate = document.getElementById('serv-plate').value.trim().toUpperCase();
                const status = document.getElementById('plate-status');
                
                if(!plate) return;

                const user = this.db.users.find(u => u.plate === plate);
                if(user) {
                    status.innerHTML = `<span style="color:var(--success);"><i class="fa-solid fa-circle-check"></i> ${user.model} (${user.name})</span>`;
                    return user;
                } else {
                    status.innerHTML = `<span style="color:var(--danger);"><i class="fa-solid fa-circle-xmark"></i> Araç bulunamadı!</span>`;
                    return null;
                }
            }

            addService(e) {
                e.preventDefault();
                const plate = document.getElementById('serv-plate').value.trim().toUpperCase();
                const user = this.db.users.find(u => u.plate === plate);
                
                if (!user) return this.showToast('Geçerli bir araç bulunamadı.', 'error');

                const newService = {
                    id: 'srv_' + Date.now(),
                    masterId: this.currentUser.id,
                    vin: user.vin,
                    plate: user.plate,
                    km: document.getElementById('serv-km').value,
                    date: document.getElementById('serv-date').value,
                    desc: document.getElementById('serv-desc').value,
                    isRated: false,
                    rating: 0,
                    comment: ''
                };

                this.db.services.push(newService);
                this.saveDB(this.db);
                this.showToast('İşlem Başarıyla Kaydedildi!', 'success');
                
                // Formu Temizle
                document.getElementById('service-add-form').reset();
                document.getElementById('plate-status').innerHTML = '';
                this.loadMasterDashboard();
            }

            // --- PUANLAMA ---
            openRateModal(sid) {
                this.tempSid = sid;
                this.tempRating = 0;
                document.getElementById('modal-rate').classList.remove('hidden');
                document.querySelectorAll('.star-rating i').forEach(i => i.className = 'fa-regular fa-star');
            }

            closeModal() {
                document.getElementById('modal-rate').classList.add('hidden');
            }

            submitRating() {
                if(!this.tempRating) return this.showToast('Lütfen puan seçin.', 'error');
                
                const sIndex = this.db.services.findIndex(s => s.id === this.tempSid);
                if(sIndex > -1) {
                    this.db.services[sIndex].isRated = true;
                    this.db.services[sIndex].rating = this.tempRating;
                    this.db.services[sIndex].comment = document.getElementById('rate-comment').value;

                    // Usta Puanını Güncelle
                    const mIndex = this.db.masters.findIndex(m => m.id === this.db.services[sIndex].masterId);
                    if(mIndex > -1) {
                        const m = this.db.masters[mIndex];
                        const total = (m.rating * m.ratingCount) + this.tempRating;
                        m.ratingCount++;
                        m.rating = (total / m.ratingCount).toFixed(1);
                    }
                    this.saveDB(this.db);
                    this.showToast('Puanınız Ulaşmıştır, Teşekkürler!', 'success');
                    this.closeModal();
                    this.loadUserDashboard();
                }
            }

            initEvents() {
                document.getElementById('login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.login(document.getElementById('login-id').value.trim(), document.getElementById('login-pass').value.trim());
                });

                document.getElementById('register-form').addEventListener('submit', (e) => this.register(e));
                
                const srvForm = document.getElementById('service-add-form');
                if(srvForm) srvForm.addEventListener('submit', (e) => this.addService(e));

                document.getElementById('logout-btn').addEventListener('click', () => this.logout());

                document.querySelectorAll('.star-rating i').forEach(star => {
                    star.addEventListener('click', (e) => {
                        const val = parseInt(e.target.dataset.val);
                        this.tempRating = val;
                        document.querySelectorAll('.star-rating i').forEach(s => {
                            s.className = parseInt(s.dataset.val) <= val ? 'fa-solid fa-star' : 'fa-regular fa-star';
                        });
                    });
                });
                
                document.getElementById('btn-submit-rate').addEventListener('click', () => this.submitRating());
            }

            showToast(msg, type) {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.innerHTML = type === 'success' 
                    ? `<i class="fa-solid fa-circle-check" style="font-size:1.2rem;"></i> ${msg}` 
                    : `<i class="fa-solid fa-circle-exclamation" style="font-size:1.2rem;"></i> ${msg}`;
                c.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }

            formatDate(d) {
                return new Date(d).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
            }
        }

        const app = new App();
    </script>
</body>
</html>
